# Phase 3 テスト計画書

## テスト概要
Phase 3で実装した機能の動作確認手順をまとめたドキュメントです。

## 前提条件
- Botが正常に起動していること
- 必要な環境変数が設定されていること
- Discordサーバーに適切な権限でBotが追加されていること
- テスト用のチャンネルが作成されていること

## テスト手順

### 1. 環境設定の確認

1. `.env`ファイルに以下が設定されているか確認：
   ```
   EVALUATION_RESULT_CHANNEL_ID=<結果投稿チャンネルID>
   SUMMARY_NOTIFICATION_CHANNEL_ID=<通知チャンネルID>
   EXCLUDED_CHANNEL_IDS=<除外チャンネルID（カンマ区切り）>
   CRON_SCHEDULE=0 18 * * *
   ```

2. コマンドのデプロイ：
   ```bash
   npm run deploy-commands
   ```

3. Botの起動：
   ```bash
   npm start
   ```

4. ログに以下が表示されることを確認：
   - `Scheduler initialized with cron pattern: 0 18 * * *`
   - `Daily evaluation scheduled at 18:00 JST`

### 2. 手動評価のテスト

1. Discordで`/trigger-evaluation`コマンドを実行（管理者権限必要）

2. 以下を確認：
   - コマンド実行時に「定期評価を手動で開始しました」と表示される
   - ログに`Manual evaluation triggered`が出力される
   - 評価完了後、通知チャンネルに完了通知が投稿される
   - 結果チャンネルに詳細結果が投稿される

### 3. 評価結果確認機能のテスト

#### 3.1 最近の評価一覧
1. `/check-evaluation`を実行
2. 過去7日間の評価一覧が表示されることを確認

#### 3.2 特定評価の詳細
1. 評価一覧から評価IDをコピー
2. `/check-evaluation evaluation_id:<ID>`を実行
3. 詳細な評価結果が表示されることを確認

#### 3.3 ユーザー評価履歴
1. `/check-evaluation user:@<ユーザー名>`を実行
2. 指定ユーザーの評価履歴が表示されることを確認

### 4. NFTエクスポート機能のテスト

1. `/export-nft`を実行（管理者権限必要）
2. JSONファイルがダウンロードできることを確認
3. ファイル内容に以下が含まれることを確認：
   - ユーザーID
   - スコア情報
   - 評価期間
   - 貢献内容の詳細

### 5. 定期実行のテスト

#### 5.1 テスト用スケジュール設定
1. `.env`の`CRON_SCHEDULE`を現在時刻の5分後に設定
   例: 現在14:30なら`35 14 * * *`に設定

2. Botを再起動

3. 指定時刻に自動実行されることを確認

#### 5.2 本番スケジュールの確認
1. `.env`の`CRON_SCHEDULE`を`0 18 * * *`に戻す
2. Botを再起動
3. ログに正しいスケジュールが表示されることを確認

### 6. エラーハンドリングのテスト

#### 6.1 権限不足エラー
1. 管理者権限のないユーザーで`/trigger-evaluation`を実行
2. 「このコマンドは管理者のみ使用できます」と表示されることを確認

#### 6.2 チャンネルアクセスエラー
1. 存在しないチャンネルIDを環境変数に設定
2. 評価を実行
3. ログにエラーが記録されることを確認

### 7. パフォーマンステスト

1. 複数のチャンネルにテストメッセージを投稿
2. 評価を実行
3. 以下を確認：
   - 処理時間が妥当か
   - メモリ使用量が適切か
   - API制限に引っかからないか

## チェックリスト

- [ ] スケジューラーが正常に初期化される
- [ ] 手動評価が正常に実行できる
- [ ] 評価結果が通知チャンネルに投稿される
- [ ] 評価詳細が結果チャンネルに投稿される
- [ ] `/check-evaluation`で評価一覧が表示できる
- [ ] `/check-evaluation evaluation_id:<ID>`で詳細が表示できる
- [ ] `/check-evaluation user:@<user>`でユーザー履歴が表示できる
- [ ] `/export-nft`でJSONファイルがエクスポートできる
- [ ] 定期実行が指定時刻に動作する
- [ ] エラーが適切にハンドリングされる
- [ ] ログが適切に出力される

## トラブルシューティング

### 問題: スケジューラーが動作しない
- 解決策: 
  1. タイムゾーンが正しく設定されているか確認
  2. node-cronがインストールされているか確認
  3. ログでエラーを確認

### 問題: 評価結果が投稿されない
- 解決策:
  1. チャンネルIDが正しいか確認
  2. Botの権限を確認
  3. Firestoreの接続を確認

### 問題: コマンドが表示されない
- 解決策:
  1. `npm run deploy-commands`を実行
  2. Discordクライアントを再起動
  3. Botの権限を確認